{"version":3,"file":"gpu.js","sources":["../../../src/render/gpu.ts"],"sourcesContent":["export class GPU {\r\n    adapter: GPUAdapter;\r\n    device: GPUDevice;\r\n    preferredFormat: GPUTextureFormat;\r\n    async init(): Promise<GPU | null> {\r\n        if (!('gpu' in navigator)) {\r\n            console.warn(\"User agent doesn't support WebGPU.\");\r\n            return null;\r\n        }\r\n        const gpuAdapter = await navigator.gpu.requestAdapter({\r\n            powerPreference: 'high-performance'\r\n        });\r\n        if (!gpuAdapter) {\r\n            console.warn('No WebGPU adapters found.');\r\n            return null;\r\n        }\r\n        this.adapter = gpuAdapter;\r\n        this.preferredFormat = navigator.gpu.getPreferredCanvasFormat();\r\n        this.device = await gpuAdapter.requestDevice();\r\n        this.device.lost.then((info) => {\r\n            console.error(`WebGPU device was lost: ${info.message}`);\r\n            this.device = null;\r\n            if (info.reason != 'destroyed') {\r\n                this.init();\r\n            }\r\n        });\r\n        return this;\r\n    }\r\n    createBuffer(usage: number, buffer_or_size: (ArrayLike<number> & ArrayBuffer) | number, label?: string) {\r\n        let gpuBuffer = this.device.createBuffer({\r\n            size: (buffer_or_size as ArrayLike<number> & ArrayBuffer)?.byteLength ?? (buffer_or_size as number),\r\n            usage, label,\r\n            mappedAtCreation: typeof buffer_or_size != \"number\"\r\n        });\r\n        if (typeof buffer_or_size != \"number\") {\r\n            let jsBuffer = new (buffer_or_size.constructor as ArrayBufferConstructor)(gpuBuffer.getMappedRange());\r\n            (jsBuffer as Float32Array).set(buffer_or_size);\r\n            gpuBuffer.unmap();\r\n        }\r\n        return gpuBuffer;\r\n    }\r\n    createBindGroup(pipeline: GPUPipelineBase, index: number, entries: Array<GPUBindingResource>, label?: string) {\r\n        let descriptor: GPUBindGroupDescriptor = {\r\n            layout: pipeline.getBindGroupLayout(index),\r\n            entries: entries.map((e, i) => ({ binding: i, resource: e }))\r\n        };\r\n        if (label) descriptor.label = label;\r\n        return this.device.createBindGroup(descriptor);\r\n    }\r\n    getContext(dom: HTMLCanvasElement, config?: GPUContextConfig): GPUCanvasContext {\r\n        let ctxt = dom.getContext('webgpu') as unknown as GPUCanvasContext;\r\n        ctxt.configure({\r\n            device: this.device,\r\n            format: config?.format ?? this.preferredFormat,\r\n            ...config\r\n        });\r\n        return ctxt;\r\n    }\r\n}\r\ninterface ArrayBufferConstructor {\r\n    readonly prototype: ArrayBuffer;\r\n    new(byteLength: number): ArrayBuffer;\r\n    new(array: ArrayLike<number> | ArrayBufferLike): ArrayBuffer;\r\n    new(buffer: ArrayBufferLike, byteOffset?: number, length?: number): ArrayBuffer;\r\n    isView(arg: any): arg is ArrayBufferView;\r\n}\r\ninterface GPUContextConfig {\r\n    format?: GPUTextureFormat;\r\n    alphaMode?: GPUCanvasAlphaMode;\r\n    usage?: GPUTextureUsageFlags;\r\n    viewFormats?: Iterable<GPUTextureFormat>;\r\n    colorSpace?: PredefinedColorSpace;\r\n}"],"names":[],"mappings":"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"}