{"version":3,"file":"objparser.js","sources":["../../../src/mesh/objparser.ts"],"sourcesContent":["import { FaceIndexMesh, FaceIndexMeshData } from \"./face/facemesh\";\r\nimport { TetraIndexMesh } from \"./tetra/tetramesh\";\r\n\r\ninterface IndexMesh extends FaceIndexMeshData {\r\n    positionIndex?: Uint32Array;\r\n    normalIndex?: Uint32Array;\r\n    uvwIndex?: Uint32Array;\r\n    count?: number;\r\n}\r\nexport class ObjFile {\r\n    data: string;\r\n    constructor(data: string | TetraIndexMesh | FaceIndexMesh) {\r\n        this.data = this.stringify(data);\r\n    }\r\n    private stringify(data: string | TetraIndexMesh | FaceIndexMesh) {\r\n        if (typeof data === \"string\") return data;\r\n        let out = \"# Tesserxel ObjFile Parser\\n# github.com/wxyhly/tesserxel\\n\";\r\n        out += writeVertexLike(\"v\", data.position);\r\n        if (data.normal) out += writeVertexLike(\"vn\", data.normal);\r\n        if (data.uvw) out += writeVertexLike(\"vt\", data.uvw);\r\n        if ((data as TetraIndexMesh).positionIndex) {\r\n            let m = data as TetraIndexMesh;\r\n            out += writeFaceLike(\"t\", m.positionIndex, m.uvwIndex, m.normalIndex, 4);\r\n            return out;\r\n        }\r\n        let m = data as FaceIndexMesh;\r\n        if (m.triangle) {\r\n            out += writeFaceLike(\"f\", m.triangle.position, m.triangle.uvw, m.triangle.normal, 3);\r\n        }\r\n        if (m.quad) {\r\n            out += writeFaceLike(\"f\", m.quad.position, m.quad.uvw, m.quad.normal, 4);\r\n        }\r\n        return out;\r\n        function writeVertexLike(identifier: string, data: Float32Array) {\r\n            let out = \"\\n\";\r\n            const reg = new RegExp(\" \" + (0).toPrecision(7) + \"$\", \"g\");\r\n            for (let i = 0, l = data.length; i < l; i += 4) {\r\n                let line = identifier;\r\n                for (let q = 0; q < 4; q++) {\r\n                    line += \" \" + data[i + q].toPrecision(7);\r\n                }\r\n                line = line.trim().replace(reg, \"\");\r\n                if (identifier === \"vt\") line = line.replace(reg, \"\");\r\n                out += line + \"\\n\";\r\n            }\r\n            return out;\r\n        }\r\n        function writeFaceLike(identifier: string, v: Uint32Array, vt: Uint32Array, vn: Uint32Array, stride: number) {\r\n            let out = \"\\n\";\r\n            for (let i = 0, l = v.length; i < l; i += stride) {\r\n                let line = identifier;\r\n                for (let q = 0; q < stride; q++) {\r\n                    line += \" \" + (v[i + q] + 1);\r\n                    if (vt) line += \"/\" + (vt[i + q] + 1);\r\n                    if (vn) line += \"/\" + (vn[i + q] + 1);\r\n                    line = line.replace(/\\/+$/, \"\");\r\n                }\r\n                out += line + \"\\n\";\r\n            }\r\n            return out;\r\n        }\r\n    }\r\n    parse() {\r\n        let lines = this.data.split(\"\\n\");\r\n        let v = [];\r\n        let vt = [];\r\n        let vn = [];\r\n        let quad = {\r\n            v: [],\r\n            vt: [],\r\n            vn: [],\r\n        }\r\n        let tetra = {\r\n            v: [],\r\n            vt: [],\r\n            vn: [],\r\n        }\r\n        let triangle = {\r\n            v: [],\r\n            vt: [],\r\n            vn: [],\r\n        }\r\n        for (let i = 0, l = lines.length; i < l; i++) {\r\n            let line = lines[i].trim();\r\n            if (isCommentOrEmpty(line)) continue;\r\n            let splitArr = line.toLowerCase().split(/\\s/g);\r\n            switch (splitArr[0]) {\r\n                case \"o\":\r\n                    // parseObj(splitArr);\r\n                    break;\r\n                case \"v\":\r\n                    parseVertexLike(v, splitArr);\r\n                    break;\r\n                case \"vt\":\r\n                    parseVertexLike(vt, splitArr);\r\n                    break;\r\n                case \"vn\":\r\n                    parseVertexLike(vn, splitArr);\r\n                    break;\r\n                case \"f\":\r\n                    if (splitArr.length === 5) {\r\n                        parseFaceLike(quad, splitArr);\r\n                    } else if (splitArr.length === 4) {\r\n                        parseFaceLike(triangle, splitArr);\r\n                    } else {\r\n                        error(i, \"Unsupported polygonal face: Only triangles and quads are allowed.\");\r\n                    }\r\n                    break;\r\n                case \"t\":\r\n                    if (splitArr.length === 5) {\r\n                        parseFaceLike(tetra, splitArr);\r\n                    } else {\r\n                        error(i, `Vertices of tetrahedron must be 4, found ${splitArr.length - 1} vertices.`);\r\n                    }\r\n            }\r\n        }\r\n\r\n        let out: IndexMesh = tetra.v.length ? {\r\n            position: new Float32Array(v),\r\n            positionIndex: new Uint32Array(tetra.v)\r\n        } : {\r\n            position: new Float32Array(v)\r\n        }\r\n        if (vt.length) out.uvw = new Float32Array(vt);\r\n        if (vn.length) out.normal = new Float32Array(vn);\r\n        if (triangle.v.length) {\r\n            out.triangle = {\r\n                position: new Uint32Array(triangle.v)\r\n            }\r\n            if (triangle.vt.length) out.triangle.uvw = new Uint32Array(triangle.vt);\r\n            if (triangle.vn.length) out.triangle.normal = new Uint32Array(triangle.vn);\r\n        }\r\n        if (quad.v.length) {\r\n            out.quad = {\r\n                position: new Uint32Array(quad.v)\r\n            }\r\n            if (quad.vt.length) out.quad.uvw = new Uint32Array(quad.vt);\r\n            if (quad.vn.length) out.quad.normal = new Uint32Array(quad.vn);\r\n        }\r\n\r\n        if (tetra.v.length) {\r\n            if (tetra.vt.length) out.uvwIndex = new Uint32Array(tetra.vt);\r\n            if (tetra.vn.length) out.normalIndex = new Uint32Array(tetra.vn);\r\n\r\n        }\r\n        return out;\r\n        function parseVertexLike(dst: number[], splitArr: string[]) {\r\n            while (splitArr.length < 5) { splitArr.push(\"0\"); }\r\n            for (let i = 1, l = splitArr.length; i < l; i++) {\r\n                dst.push(Number(splitArr[i]));\r\n            }\r\n        }\r\n        function parseFaceLike(dst: { v: number[], vt: number[], vn: number[] }, splitArr: string[]) {\r\n            for (let i = 1, l = splitArr.length; i < l; i++) {\r\n                let attrs = splitArr[i].split(\"/\");\r\n                dst.v.push(Number(attrs[0]) - 1);\r\n                if (attrs[1]) dst.vt.push(Number(attrs[1]) - 1);\r\n                if (attrs[2]) dst.vn.push(Number(attrs[2]) - 1);\r\n            }\r\n        }\r\n        function isCommentOrEmpty(line: string) {\r\n            return line === \"\" || line[0] === \"#\";\r\n        }\r\n        function error(line: number, msg: string) {\r\n            console.error(\"ObjFileParser: \" + msg + \"\\n at line \" + line + `\"${lines[line]}\"`);\r\n        }\r\n    }\r\n}"],"names":[],"mappings":"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"}