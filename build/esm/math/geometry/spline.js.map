{"version":3,"file":"spline.js","sources":["../../../../src/math/geometry/spline.ts"],"sourcesContent":["import { Obj4 } from \"../algebra/affine.js\";\r\nimport { Rotor } from \"../algebra/rotor.js\";\r\nimport { Vec4 } from \"../algebra/vec4.js\";\r\ninterface SplineData { points: Vec4[], rotors: Rotor[], curveLength: number[] }\r\nexport class Spline {\r\n    points: Vec4[];\r\n    derives: Vec4[];\r\n    constructor(points: Vec4[], derives: Vec4[]) {\r\n        if (points.length !== derives.length) console.error(\"Spline: points and derives lengths don't agree\");\r\n        this.points = points;\r\n        this.derives = derives;\r\n    }\r\n    generate(seg: number): SplineData {\r\n        let points: Vec4[] = [];\r\n        let prevPoint: Vec4 | undefined;\r\n        let prevDir = Vec4.w;\r\n        let prevRotor = new Rotor();\r\n        let rotors: Rotor[] = [];\r\n        let curveLength: number[] = [];\r\n        let curveLenSum = 0;\r\n        for (let i = 0; i < this.points.length - 1; i++) {\r\n            let p0 = this.points[i];\r\n            let p1 = this.points[i + 1];\r\n            let d0 = this.derives[i];\r\n            let d1 = this.derives[i + 1];\r\n            let p01 = p0.sub(p1);\r\n            let A = p01.mulf(2).adds(d0).adds(d1);\r\n            let B = d0.mulf(-2).subs(d1).subs(p01.mulfs(3));\r\n            let seginv = 1 / seg;\r\n            for (let j = 0; j <= seg; j++) {\r\n                if (j === seg && i !== this.points.length - 2) break;\r\n                let t = j * seginv;\r\n                let curPoint = new Vec4(\r\n                    p0.x + t * (d0.x + t * (B.x + t * A.x)),\r\n                    p0.y + t * (d0.y + t * (B.y + t * A.y)),\r\n                    p0.z + t * (d0.z + t * (B.z + t * A.z)),\r\n                    p0.w + t * (d0.w + t * (B.w + t * A.w))\r\n                );\r\n                if (prevPoint) {\r\n                    let curDir = curPoint.sub(prevPoint);\r\n                    let dirLen = curDir.norm();\r\n                    curDir.divfs(dirLen);\r\n                    prevRotor.mulsl(Rotor.lookAt(prevDir, curDir));\r\n                    // console.log(curDir.dot(Vec4.w.rotate(prevRotor)));\r\n                    prevDir = curDir;\r\n                    rotors.push(prevRotor.clone());\r\n                    curveLength.push(curveLenSum);\r\n                    curveLenSum += dirLen;\r\n                }\r\n                prevPoint = curPoint;\r\n                points.push(curPoint);\r\n            }\r\n        }\r\n        let lastDerive = this.derives[this.derives.length - 1];\r\n        if (\r\n            points[0].x == prevPoint!.x && points[0].y == prevPoint!.y &&\r\n            points[0].z == prevPoint!.z && points[0].w == prevPoint!.w &&\r\n            this.derives[0].x == lastDerive.x && this.derives[0].y == lastDerive.y &&\r\n            this.derives[0].z == lastDerive.z && this.derives[0].w == lastDerive.w\r\n        ) {\r\n            rotors.push(rotors[0]);\r\n        } else {\r\n            rotors.push(prevRotor);\r\n        }\r\n        curveLength.push(curveLenSum);\r\n        return { points, rotors, curveLength }\r\n    }\r\n    getValue(t: number) {\r\n        let i = Math.floor(t);\r\n        t -= i;\r\n        // i %= this.points.length - 1;\r\n        // if (i < 0) i += this.points.length - 1\r\n        let p0 = this.points[i];\r\n        let p1 = this.points[i + 1];\r\n        let d0 = this.derives[i];\r\n        let d1 = this.derives[i + 1];\r\n        let p01 = p0.sub(p1);\r\n        let A = p01.mulfs(2).adds(d0).adds(d1);\r\n        let B = d0.mulf(-2).subs(d1).subs(p01.mulfs(1.5));\r\n        let x = p0.x + t * (d0.x + t * (B.x + t * A.x));\r\n        let y = p0.y + t * (d0.y + t * (B.y + t * A.y));\r\n        let z = p0.z + t * (d0.z + t * (B.z + t * A.z));\r\n        let w = p0.w + t * (d0.w + t * (B.w + t * A.w));\r\n        return new Vec4(x, y, z, w);\r\n    }\r\n    getPositionAtLength(s: number, data: SplineData) {\r\n        let i = 0;\r\n        for (; i < data.curveLength.length; i++) {\r\n            if (data.curveLength[i] > s) { break; }\r\n        }\r\n        let a = data.curveLength[i - 1];\r\n        let b = data.curveLength[i];\r\n        let ratio = (s - a) / (b - a);\r\n        return data.points[i - 1].mulf(1 - ratio).addmulfs(data.points[i], ratio);\r\n    }\r\n    getObj4AtLength(s: number, data: SplineData) {\r\n        let i = 0;\r\n        for (; i < data.curveLength.length; i++) {\r\n            if (data.curveLength[i] > s) { break; }\r\n        }\r\n        let a = data.curveLength[i - 1];\r\n        let b = data.curveLength[i];\r\n        let ratio = (s - a) / (b - a);\r\n        return new Obj4(\r\n            data.points[i - 1].mulf(1 - ratio).addmulfs(data.points[i], ratio),\r\n            Rotor.slerp(data.rotors[i - 1], data.rotors[i], ratio)\r\n        );\r\n    }\r\n}"],"names":[],"mappings":"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"}