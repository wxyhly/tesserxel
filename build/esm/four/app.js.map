{"version":3,"file":"app.js","sources":["../../../src/four/app.ts"],"sourcesContent":["import { ControllerConfig, ControllerRegistry, IController, RetinaController } from \"../util/ctrl.js\";\r\nimport { Renderer, RendererConfig } from \"./renderer.js\";\r\nimport { Camera, PerspectiveCamera, Scene } from \"./scene.js\";\r\n\r\nexport class App {\r\n    canvas: HTMLCanvasElement;\r\n    renderer: Renderer;\r\n    scene: Scene;\r\n    camera: Camera;\r\n    controllerRegistry: ControllerRegistry;\r\n    retinaController?: RetinaController;\r\n    onresize?: (e: { width: number, height: number }) => void;\r\n    private _onFrame?: () => void;\r\n    private _running: boolean = false;\r\n    private _autoResize: boolean = false;\r\n    private _resizeHandler?: () => void;\r\n\r\n    enableAutoResize() {\r\n        if (this._autoResize) return;\r\n        this._autoResize = true;\r\n        this._resizeHandler = () => {\r\n            const width = window.innerWidth * window.devicePixelRatio;\r\n            const height = window.innerHeight * window.devicePixelRatio;\r\n            if (this.onresize) this.onresize({ width, height });\r\n            this.renderer.setSize({ width, height });\r\n        };\r\n        this._resizeHandler();\r\n        window.addEventListener(\"resize\", this._resizeHandler);\r\n    }\r\n    disableAutoResize() {\r\n        if (!this._autoResize || !this._resizeHandler) return;\r\n        window.removeEventListener(\"resize\", this._resizeHandler);\r\n        this._autoResize = false;\r\n        this._resizeHandler = undefined;\r\n    }\r\n    private constructor(\r\n        canvas: HTMLCanvasElement,\r\n        renderer: Renderer,\r\n        scene: Scene,\r\n        camera: Camera,\r\n        controllerRegistry: ControllerRegistry\r\n    ) {\r\n        this.canvas = canvas;\r\n        this.renderer = renderer;\r\n        this.scene = scene;\r\n        this.camera = camera;\r\n        this.controllerRegistry = controllerRegistry;\r\n    }\r\n\r\n    static async create(opts: {\r\n        canvas: HTMLCanvasElement;\r\n        scene?: Scene;\r\n        camera?: Camera;\r\n        controls?: IController[];\r\n        autoSetSize?: boolean;\r\n        renderConfig?: RendererConfig;\r\n        controllerConfig?: ControllerConfig;\r\n    }): Promise<App> {\r\n        const renderer = await new Renderer(opts.canvas, opts.renderConfig).init();\r\n        const scene = opts.scene ?? new Scene();\r\n        const camera = opts.camera ?? new PerspectiveCamera();\r\n        scene.add(camera);\r\n        const controls = opts.controls ?? [new RetinaController(renderer.core)];\r\n        const controllerRegistry = new ControllerRegistry(opts.canvas, controls, opts.controllerConfig);\r\n\r\n        const app = new App(opts.canvas, renderer, scene, camera, controllerRegistry);\r\n        if (opts.autoSetSize !== false) {\r\n            app.enableAutoResize();\r\n        }\r\n        if (!opts.controls) app.retinaController = controls[0] as RetinaController;\r\n        return app;\r\n    }\r\n    run(onFrame?: () => void) {\r\n        this._onFrame = onFrame;\r\n        this._running = true;\r\n        const frame = () => {\r\n            if (!this._running) return;\r\n            this.controllerRegistry.update();\r\n            this._onFrame?.();\r\n            this.renderer.render(this.scene, this.camera);\r\n            requestAnimationFrame(frame);\r\n        };\r\n        frame();\r\n    }\r\n    stop() {\r\n        this._running = false;\r\n    }\r\n}"],"names":[],"mappings":"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"}