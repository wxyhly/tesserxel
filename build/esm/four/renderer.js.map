{"version":3,"file":"renderer.js","sources":["../../../src/four/renderer.ts"],"sourcesContent":["import { SliceRenderer, TetraSlicePipeline } from \"../render/slice/slice.js\";\r\nimport { GPU } from \"../render/gpu.js\";\r\nimport { AmbientLight, DirectionalLight, PointLight, SpotLight, _initLightShader, _updateWorldLight } from \"./light.js\";\r\nimport { Camera, Mesh, Object, Scene } from \"./scene.js\";\r\nimport { Material } from \"./material.js\";\r\nimport { Vec3 } from \"../math/algebra/vec3.js\";\r\nexport interface RendererConfig {\r\n    posdirLightsNumber?: number;\r\n    spotLightsNumber?: number;\r\n}\r\n/** threejs like 4D lib */\r\nexport class Renderer {\r\n    core: SliceRenderer;\r\n    gpu: GPU;\r\n    canvas: HTMLCanvasElement;\r\n    pipelines: { [label: string]: TetraSlicePipeline | \"compiling\" } = {};\r\n    jsBuffer = new Float32Array(1024);\r\n    uCamMatBuffer: GPUBuffer; // contain inv and uninv affineMat\r\n    uWorldLightBuffer: GPUBuffer;\r\n    lightShaderInfomation = _initLightShader();\r\n    autoSetSizeHandler: () => void;\r\n    private cameraInScene: boolean;\r\n    private safeTetraNumInOnePass: number;\r\n    private tetraNumOccupancyRatio: number = 0.08;\r\n    private maxTetraNumInOnePass: number;\r\n    private context: GPUCanvasContext;\r\n    constructor(canvas: HTMLCanvasElement, config?: RendererConfig) {\r\n        this.canvas = canvas;\r\n        this.lightShaderInfomation = _initLightShader(config);\r\n    }\r\n    setBackgroudColor(color: GPUColor) {\r\n        this.core.setDisplayConfig({ screenBackgroundColor: color });\r\n    }\r\n    async init() {\r\n        this.gpu = await new GPU().init();\r\n        if (!this.gpu) {\r\n            throw \"No availiable GPU device found. Please check whether WebGPU is enabled on your browser.\";\r\n            return null;\r\n        }\r\n        this.context = this.gpu.getContext(this.canvas);\r\n        this.core = new SliceRenderer(this.gpu);\r\n        this.uCamMatBuffer = this.gpu.createBuffer(GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST, (4 * 5 * 2) * 4, \"uCamMat\");\r\n        this.uWorldLightBuffer = this.gpu.createBuffer(GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST, this.lightShaderInfomation.uWorldLightBufferSize, \"uWorldLight\");\r\n        this.core.setDisplayConfig({ canvasSize: { width: this.canvas.width * devicePixelRatio, height: this.canvas.height * devicePixelRatio } });\r\n        this.safeTetraNumInOnePass = this.core.getSafeTetraNumInOnePass();\r\n\r\n        await this.core.init();\r\n        return this;\r\n    }\r\n    // todo: add computePipeLinePool\r\n    fetchPipelineName(identifier: string): string {\r\n        return identifier;\r\n    }\r\n    fetchPipeline(identifier: string): TetraSlicePipeline | \"compiling\" {\r\n        return this.pipelines[this.fetchPipelineName(identifier)];\r\n    }\r\n    pullPipeline(identifier: string, pipeline: TetraSlicePipeline | \"compiling\") {\r\n        if (this.pipelines[identifier] && this.pipelines[identifier] !== \"compiling\")\r\n            throw \"FOUR Renderer: Repetitive material pipeline creation occured.\";\r\n        this.pipelines[identifier] = pipeline;\r\n    }\r\n    updateObject(o: Object) {\r\n        for (let c of o.child) {\r\n            if (c.alwaysUpdateCoord) {\r\n                c.needsUpdateCoord = true;\r\n            }\r\n            if (c.needsUpdateCoord || o.needsUpdateCoord) {\r\n                c.worldCoord.setFromObj4(c).mulsl(o.worldCoord);\r\n\r\n                c.needsUpdateCoord = true;\r\n            }\r\n            if (c.visible) {\r\n                this.updateObject(c);\r\n                c.needsUpdateCoord = false;\r\n            }\r\n        }\r\n        if (o instanceof Mesh) {\r\n            this.updateMesh(o);\r\n        } else if (o instanceof AmbientLight && o.visible) {\r\n            this.ambientLightDensity.adds(o.density);\r\n        } else if (o instanceof PointLight && o.visible) {\r\n            this.pointLights.push(o);\r\n        } else if (o instanceof SpotLight && o.visible) {\r\n            if (o.needsUpdateCoord) {\r\n                o.worldDirection.mulmatvset(o.worldCoord.mat, o.direction);\r\n            }\r\n            this.spotLights.push(o);\r\n        } else if (o instanceof DirectionalLight && o.visible) {\r\n            if (o.needsUpdateCoord) {\r\n                o.worldDirection.mulmatvset(o.worldCoord.mat, o.direction);\r\n            }\r\n            this.directionalLights.push(o);\r\n        } else if (o.needsUpdateCoord && o === this.activeCamera) {\r\n            this.cameraInScene = true;\r\n            o.worldCoord.inv().writeBuffer(this.jsBuffer);\r\n            o.worldCoord.writeBuffer(this.jsBuffer, 20);\r\n            this.gpu.device.queue.writeBuffer(this.uCamMatBuffer, 0, this.jsBuffer, 0, 40);\r\n        }\r\n    }\r\n    // this may fail to add to drawlist if pipeline creation is not finished yet\r\n    addToDrawList(m: Mesh) {\r\n        let pipeline = this.fetchPipeline(m.material.identifier);\r\n        // attention: this is an async function, rendering will be in the future tick\r\n        if (!pipeline) { m.material.bindGroup = null; m.bindGroup = null; m.material.compile(this); return; }\r\n        if (pipeline === \"compiling\") return;\r\n        // if this material can use other's pipeline, it hasn't compiled but also need some initiations\r\n        if (!m.material.compiled) { m.material.init(this); }\r\n        let groupName = m.material.uuid;\r\n        let group = m.material.declUniformLocation ? 1 : 0;\r\n        if (!this.drawList[groupName]) {\r\n            let bindGroup = this.core.createFragmentShaderBindGroup(pipeline, group, [this.uWorldLightBuffer], \"WorldLightGroup\");\r\n            this.drawList[groupName] = {\r\n                pipeline: pipeline, meshes: [],\r\n                bindGroup: { group, binding: bindGroup }, tetraCount: 0\r\n            };\r\n        }\r\n        let list = this.drawList[groupName];\r\n        // while (list.next) {\r\n        //     list = this.drawList[list.next]; //go to the end of chain table\r\n        // }\r\n        // list.tetraCount += m.geometry.jsBuffer.tetraCount;\r\n        list.meshes.push(m);\r\n        // if (list.tetraCount > this.maxTetraNumInOnePass) {\r\n        //     // append a new node to chain, wait for accept new objects next time\r\n        //     groupName = list.next = math.generateUUID();\r\n        //     this.drawList[groupName] = {\r\n        //         pipeline: pipeline, meshes: [],\r\n        //         bindGroup: list.bindGroup, tetraCount: 0\r\n        //     };\r\n        // }\r\n        if (!m.bindGroup) {\r\n            let buffers = [\r\n                ...m.material.fetchBuffer(m.geometry),\r\n                m.uObjMatBuffer,\r\n                this.uCamMatBuffer\r\n            ];\r\n            m.bindGroup = this.core.createVertexShaderBindGroup(pipeline, 1, buffers, m.material.identifier);\r\n        }\r\n        if (!m.material.bindGroup) {\r\n            m.material.createBindGroup(this, pipeline);\r\n        }\r\n        m.material.update(this);\r\n    }\r\n\r\n    async compileMaterials(mats: Iterable<Material> | Scene) {\r\n        let promises = [];\r\n        if (mats instanceof Scene) {\r\n            addMaterialInObject(this, promises, mats.child);\r\n        } else {\r\n            for (let m of mats) {\r\n                promises.push(m.compile(this));\r\n            }\r\n        }\r\n        await Promise.all(promises);\r\n        function addMaterialInObject(self: Renderer, promises: Promise<void>[], child: Object[]) {\r\n            for (let m of child) {\r\n                if (m instanceof Mesh) {\r\n                    let pipeline = self.fetchPipeline(m.material.identifier);\r\n                    if (!pipeline) {\r\n                        m.material.bindGroup = null; m.bindGroup = null;\r\n                        promises.push(m.material.compile(self));\r\n                    }\r\n                    if (!m.material.compiled) { m.material.init(self); }\r\n                }\r\n                addMaterialInObject(self, promises, m.child);\r\n            }\r\n        }\r\n    }\r\n    updateMesh(m: Mesh) {\r\n        if (m.needsUpdateCoord) {\r\n            m.worldCoord.writeBuffer(this.jsBuffer, 0);\r\n            m.worldCoord.mat.inv().ts().writeBuffer(this.jsBuffer, 20);\r\n            if (!m.uObjMatBuffer) {\r\n                m.uObjMatBuffer = this.gpu.createBuffer(\r\n                    GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST, (20 + 16) * 4, \"uObjMatBuffer\"\r\n                );\r\n            }\r\n            this.gpu.device.queue.writeBuffer(m.uObjMatBuffer, 0, this.jsBuffer, 0, 20 + 16);\r\n        }\r\n        if (m.geometry.needsUpdate) {\r\n            let g = m.geometry;\r\n            g.needsUpdate = false;\r\n            g.updateOBB();\r\n            if (!g.gpuBuffer) {\r\n                g.gpuBuffer = {};\r\n                let dyn = g.dynamic ? GPUBufferUsage.COPY_DST : 0;\r\n                for (let [label, value] of globalThis.Object.entries(g.jsBuffer)) {\r\n                    if (value instanceof Float32Array) {\r\n                        g.gpuBuffer[label] = this.gpu.createBuffer(\r\n                            GPUBufferUsage.STORAGE | dyn, value, \"AttributeBuffer.\" + label\r\n                        );\r\n                    }\r\n                }\r\n            } else if (g.dynamic) {\r\n                for (let [label, buffer] of globalThis.Object.entries(g.gpuBuffer)) {\r\n                    this.gpu.device.queue.writeBuffer(buffer, 0, g.jsBuffer[label]);\r\n                }\r\n            }\r\n        }\r\n        if (m.visible) this.addToDrawList(m);\r\n    }\r\n    updateScene(scene: Scene) {\r\n        this.core.setDisplayConfig({ retinaClearColor: scene.backGroundColor });\r\n        this.cameraInScene = false;\r\n        this.maxTetraNumInOnePass = this.safeTetraNumInOnePass / this.tetraNumOccupancyRatio;\r\n        for (let c of scene.child) {\r\n            if (c.alwaysUpdateCoord) {\r\n                c.needsUpdateCoord = true;\r\n            }\r\n            if (c.visible) {\r\n                if (c.needsUpdateCoord) {\r\n                    c.worldCoord.setFromObj4(c);\r\n                }\r\n                this.updateObject(c);\r\n                c.needsUpdateCoord = false;\r\n            }\r\n        }\r\n        if (this.cameraInScene === false) console.error(\"Target camera is not in the scene. Forget to add it?\");\r\n        _updateWorldLight(this);\r\n        this.updateSkyBox(scene);\r\n    }\r\n    updateSkyBox(scene: Scene) {\r\n        const skyBox = scene.skyBox;\r\n        if (!skyBox) return;\r\n        if (!skyBox.compiled) {\r\n            if (!skyBox.compiling) {\r\n                skyBox.compile(this);\r\n            }\r\n            return;\r\n        }\r\n        if (!skyBox.bindGroups) {\r\n            skyBox.getBindgroups(this);\r\n        }\r\n        skyBox.update(this);\r\n    }\r\n    ambientLightDensity = new Vec3;\r\n    directionalLights: DirectionalLight[];\r\n    spotLights: SpotLight[];\r\n    pointLights: PointLight[];\r\n\r\n    drawList: DrawList;\r\n    activeCamera: Camera;\r\n    setCamera(camera: Camera) {\r\n        if (camera.needsUpdate) {\r\n            this.core.setDisplayConfig({ camera4D: camera });\r\n            camera.needsUpdate = false;\r\n        }\r\n        this.activeCamera = camera;\r\n    }\r\n    render(scene: Scene, camera: Camera) {\r\n        this.clearState();\r\n        this.setCamera(camera);\r\n        scene.wireframe?.camera?.copyObj4(camera);\r\n        this.updateScene(scene);\r\n        this.core.render(this.context, (renderState) => {\r\n            for (let { pipeline, meshes, bindGroup } of globalThis.Object.values(this.drawList)) {\r\n                if (!meshes.length) continue; // skip empty (may caused by safe tetranum check)\r\n                let tetraState = false;\r\n                let tetraCount = 0;\r\n                let binding = [\r\n                    ...meshes[0].material.bindGroup.map((bg, binding) => ({ group: binding, binding: bg })),\r\n                    bindGroup\r\n                ];\r\n                for (let mesh of meshes) {\r\n                    if (!renderState.testWithFrustumData(mesh.geometry.obb, this.activeCamera.worldCoord, mesh.worldCoord)) continue;\r\n                    if (tetraState === false) {\r\n                        renderState.beginTetras(pipeline);\r\n                        tetraCount = 0;\r\n                        tetraState = true;\r\n                    }\r\n                    renderState.sliceTetras(mesh.bindGroup, mesh.geometry.jsBuffer.count);\r\n                    tetraCount += mesh.geometry.jsBuffer.count;\r\n                    if (tetraCount > this.maxTetraNumInOnePass) {\r\n                        renderState.drawTetras(binding);\r\n                        tetraState = false;\r\n                        tetraCount = 0;\r\n                    }\r\n                }\r\n                if (tetraState === true) {\r\n                    renderState.drawTetras(binding);\r\n                }\r\n            }\r\n            if (scene.skyBox?.bindGroups) {\r\n                renderState.drawRaytracing(scene.skyBox.pipeline, scene.skyBox.bindGroups);\r\n            }\r\n        }, scene.wireframe ? rs => scene.wireframe.render(rs) : undefined);\r\n    }\r\n    setSize(size: GPUExtent3DStrict) {\r\n        if ((size as GPUExtent3DDict).height) {\r\n            this.canvas.width = (size as GPUExtent3DDict).width;\r\n            this.canvas.height = (size as GPUExtent3DDict).height;\r\n        } else {\r\n            this.canvas.width = size[0];\r\n            this.canvas.height = size[1];\r\n        }\r\n        this.core.setDisplayConfig({ canvasSize: size });\r\n    }\r\n    private clearState() {\r\n        this.ambientLightDensity.set();\r\n        this.directionalLights = [];\r\n        this.spotLights = [];\r\n        this.pointLights = [];\r\n        this.drawList = {};\r\n    }\r\n}\r\ninterface DrawList {\r\n    [group: string]: {\r\n        pipeline: TetraSlicePipeline,\r\n        meshes: Mesh[],\r\n        bindGroup: { group: number, binding: GPUBindGroup },\r\n        tetraCount: number\r\n        next?: string // if too many objs in drawlist, split into a list table\r\n    }\r\n}"],"names":[],"mappings":"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"}