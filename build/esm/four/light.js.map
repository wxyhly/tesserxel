{"version":3,"file":"light.js","sources":["../../../src/four/light.ts"],"sourcesContent":["import { Vec3 } from \"../math/algebra/vec3.js\";\r\nimport { Vec4 } from \"../math/algebra/vec4.js\";\r\nimport { _DEG2RAD } from \"../math/const.js\";\r\nimport { Renderer, RendererConfig } from \"./renderer.js\";\r\nimport { Object } from \"./scene.js\";\r\n\r\ntype LightDensity = { r: number, g: number, b: number } | Vec3 | number[] | number;\r\nexport class Light extends Object {\r\n    density: Vec3;\r\n    constructor(density: LightDensity) {\r\n        super();\r\n        this.density = color2Vec3(density);\r\n    }\r\n}\r\nfunction color2Vec3(density: LightDensity) {\r\n    if (density instanceof Vec3) return density;\r\n    if ((density as { r: number, g: number, b: number }).r) {\r\n        return new Vec3(\r\n            (density as { r: number, g: number, b: number }).r,\r\n            (density as { r: number, g: number, b: number }).g,\r\n            (density as { r: number, g: number, b: number }).b\r\n        );\r\n    }\r\n    if (typeof density === \"number\") {\r\n        return new Vec3(density, density, density);\r\n    }\r\n    if ((density as number[]).length === 3) {\r\n        return new Vec3((density as number[])[0], (density as number[])[1], (density as number[])[2]);\r\n    }\r\n}\r\nexport class AmbientLight extends Light {\r\n    needsUpdateCoord = false;\r\n    constructor(density: LightDensity) {\r\n        super(density);\r\n    }\r\n}\r\nexport class DirectionalLight extends Light {\r\n    worldDirection = new Vec4;\r\n    direction: Vec4;\r\n    constructor(density: LightDensity, direction?: Vec4) {\r\n        super(density ?? 1.0);\r\n        this.direction = direction ?? Vec4.y.clone();\r\n    }\r\n}\r\nexport class SpotLight extends Light {\r\n    worldDirection = new Vec4;\r\n    direction: Vec4;\r\n    angle: number;\r\n    penumbra: number;\r\n    decayPower: number = 3;\r\n    constructor(density: LightDensity, angle: number, penumbra: number, direction?: Vec4) {\r\n        super(density ?? 1.0);\r\n        this.direction = direction ?? Vec4.y.clone();\r\n        this.angle = angle;\r\n        this.penumbra = penumbra;\r\n\r\n    }\r\n}\r\nexport class PointLight extends Light {\r\n    decayPower: number = 3;\r\n    constructor(density: LightDensity) {\r\n        super(density);\r\n    }\r\n}\r\n\r\nconst ambientLightSize = 4 * 4;\r\nconst structPosDirLightSize = 8 * 4;\r\nconst structSpotLightLightSize = 16 * 4;\r\nlet spotLightOffset: number;\r\nlet uWorldLightBufferSize: number;\r\nexport function _initLightShader(config?: RendererConfig) {\r\n    const posdirLightsNumber = config?.posdirLightsNumber ?? 8;\r\n    const spotLightsNumber = config?.spotLightsNumber ?? 4;\r\n    spotLightOffset = ambientLightSize + posdirLightsNumber * structPosDirLightSize;\r\n    uWorldLightBufferSize = spotLightOffset + spotLightsNumber * structSpotLightLightSize;\r\n    const lightCode = `\r\nstruct PosDirLight{\r\n    density: vec4<f32>,\r\n    pos_dir: vec4<f32>,\r\n}\r\nstruct SpotLight{\r\n    density: vec4<f32>,\r\n    pos: vec4<f32>,\r\n    dir: vec4<f32>,\r\n    params: vec4<f32>\r\n}\r\nconst blackColor = vec3<f32>(0.02);\r\nstruct WorldLight{\r\n    ambientLightDensity: vec4<f32>,\r\n    posdirLights: array<PosDirLight,${posdirLightsNumber}>,\r\n    spotLights: array<SpotLight,${spotLightsNumber}>,\r\n}\r\nfn acesFilm(x: vec3<f32>)-> vec3<f32> {\r\n    const a: f32 = 2.51;\r\n    const b: f32 = 0.03;\r\n    const c: f32 = 2.43;\r\n    const d: f32 = 0.59;\r\n    const e: f32 = 0.14;\r\n    return clamp((x * (a * x + b)) / (x * (c * x + d ) + e), vec3<f32>(0.0), vec3<f32>(1.0));\r\n}\r\n@group(1) @binding(0) var<uniform> uWorldLight: WorldLight;\r\n`;\r\n    return { posdirLightsNumber, spotLightsNumber, lightCode, uWorldLightBufferSize };\r\n}\r\nexport function _updateWorldLight(r: Renderer) {\r\n    let offset = 0;\r\n    r.jsBuffer.fill(0);\r\n    r.ambientLightDensity.writeBuffer(r.jsBuffer); offset += 4;\r\n    for (let dir of r.directionalLights) {\r\n        dir.density.writeBuffer(r.jsBuffer, offset); offset += 4;\r\n        r.jsBuffer[offset - 1] = -1.0; // marker for directional light ( < -0.5 in shader )\r\n        dir.worldDirection.writeBuffer(r.jsBuffer, offset); offset += 4;\r\n    }\r\n    for (let pt of r.pointLights) {\r\n        pt.density.writeBuffer(r.jsBuffer, offset); offset += 4;\r\n        r.jsBuffer[offset - 1] = Math.abs(pt.decayPower) + 1; // decay power and also marker for point light ( > 0.5 in shader )\r\n        pt.worldCoord.vec.writeBuffer(r.jsBuffer, offset); offset += 4;\r\n    }\r\n    offset = spotLightOffset >> 2;\r\n    for (let spt of r.spotLights) {\r\n        spt.density.writeBuffer(r.jsBuffer, offset); offset += 4;\r\n        r.jsBuffer[offset - 1] = 1.0; // marker for spotLight\r\n        spt.worldCoord.vec.writeBuffer(r.jsBuffer, offset); offset += 4;\r\n        spt.worldDirection.writeBuffer(r.jsBuffer, offset); offset += 4;\r\n        let cosineinv = 1 / (1 - Math.cos(spt.angle * _DEG2RAD * 0.5));\r\n        r.jsBuffer[offset] = cosineinv;\r\n        r.jsBuffer[offset + 1] = 1 - cosineinv;\r\n        r.jsBuffer[offset + 2] = spt.penumbra;\r\n        r.jsBuffer[offset + 3] = Math.abs(spt.decayPower) + 1;\r\n        offset += 4;\r\n    }\r\n    r.gpu.device.queue.writeBuffer(r.uWorldLightBuffer, 0, r.jsBuffer, 0, uWorldLightBufferSize >> 2);\r\n}"],"names":["Object"],"mappings":";;;;;AAOM,MAAO,KAAM,SAAQA,QAAM,CAAA;AAC7B,IAAA,OAAO,CAAO;AACd,IAAA,WAAA,CAAY,OAAqB,EAAA;AAC7B,QAAA,KAAK,EAAE,CAAC;AACR,QAAA,IAAI,CAAC,OAAO,GAAG,UAAU,CAAC,OAAO,CAAC,CAAC;KACtC;AACJ,CAAA;AACD,SAAS,UAAU,CAAC,OAAqB,EAAA;IACrC,IAAI,OAAO,YAAY,IAAI;AAAE,QAAA,OAAO,OAAO,CAAC;IAC5C,IAAK,OAA+C,CAAC,CAAC,EAAE;AACpD,QAAA,OAAO,IAAI,IAAI,CACV,OAA+C,CAAC,CAAC,EACjD,OAA+C,CAAC,CAAC,EACjD,OAA+C,CAAC,CAAC,CACrD,CAAC;AACL,KAAA;AACD,IAAA,IAAI,OAAO,OAAO,KAAK,QAAQ,EAAE;QAC7B,OAAO,IAAI,IAAI,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;AAC9C,KAAA;AACD,IAAA,IAAK,OAAoB,CAAC,MAAM,KAAK,CAAC,EAAE;AACpC,QAAA,OAAO,IAAI,IAAI,CAAE,OAAoB,CAAC,CAAC,CAAC,EAAG,OAAoB,CAAC,CAAC,CAAC,EAAG,OAAoB,CAAC,CAAC,CAAC,CAAC,CAAC;AACjG,KAAA;AACL,CAAC;AACK,MAAO,YAAa,SAAQ,KAAK,CAAA;IACnC,gBAAgB,GAAG,KAAK,CAAC;AACzB,IAAA,WAAA,CAAY,OAAqB,EAAA;QAC7B,KAAK,CAAC,OAAO,CAAC,CAAC;KAClB;AACJ,CAAA;AACK,MAAO,gBAAiB,SAAQ,KAAK,CAAA;IACvC,cAAc,GAAG,IAAI,IAAI,CAAC;AAC1B,IAAA,SAAS,CAAO;IAChB,WAAY,CAAA,OAAqB,EAAE,SAAgB,EAAA;AAC/C,QAAA,KAAK,CAAC,OAAO,IAAI,GAAG,CAAC,CAAC;QACtB,IAAI,CAAC,SAAS,GAAG,SAAS,IAAI,IAAI,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC;KAChD;AACJ,CAAA;AACK,MAAO,SAAU,SAAQ,KAAK,CAAA;IAChC,cAAc,GAAG,IAAI,IAAI,CAAC;AAC1B,IAAA,SAAS,CAAO;AAChB,IAAA,KAAK,CAAS;AACd,IAAA,QAAQ,CAAS;IACjB,UAAU,GAAW,CAAC,CAAC;AACvB,IAAA,WAAA,CAAY,OAAqB,EAAE,KAAa,EAAE,QAAgB,EAAE,SAAgB,EAAA;AAChF,QAAA,KAAK,CAAC,OAAO,IAAI,GAAG,CAAC,CAAC;QACtB,IAAI,CAAC,SAAS,GAAG,SAAS,IAAI,IAAI,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC;AAC7C,QAAA,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;AACnB,QAAA,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;KAE5B;AACJ,CAAA;AACK,MAAO,UAAW,SAAQ,KAAK,CAAA;IACjC,UAAU,GAAW,CAAC,CAAC;AACvB,IAAA,WAAA,CAAY,OAAqB,EAAA;QAC7B,KAAK,CAAC,OAAO,CAAC,CAAC;KAClB;AACJ,CAAA;AAED,MAAM,gBAAgB,GAAG,CAAC,GAAG,CAAC,CAAC;AAC/B,MAAM,qBAAqB,GAAG,CAAC,GAAG,CAAC,CAAC;AACpC,MAAM,wBAAwB,GAAG,EAAE,GAAG,CAAC,CAAC;AACxC,IAAI,eAAuB,CAAC;AAC5B,IAAI,qBAA6B,CAAC;AAC5B,SAAU,gBAAgB,CAAC,MAAuB,EAAA;AACpD,IAAA,MAAM,kBAAkB,GAAG,MAAM,EAAE,kBAAkB,IAAI,CAAC,CAAC;AAC3D,IAAA,MAAM,gBAAgB,GAAG,MAAM,EAAE,gBAAgB,IAAI,CAAC,CAAC;AACvD,IAAA,eAAe,GAAG,gBAAgB,GAAG,kBAAkB,GAAG,qBAAqB,CAAC;AAChF,IAAA,qBAAqB,GAAG,eAAe,GAAG,gBAAgB,GAAG,wBAAwB,CAAC;AACtF,IAAA,MAAM,SAAS,GAAG,CAAA;;;;;;;;;;;;;;sCAcgB,kBAAkB,CAAA;kCACtB,gBAAgB,CAAA;;;;;;;;;;;CAWjD,CAAC;IACE,OAAO,EAAE,kBAAkB,EAAE,gBAAgB,EAAE,SAAS,EAAE,qBAAqB,EAAE,CAAC;AACtF,CAAC;AACK,SAAU,iBAAiB,CAAC,CAAW,EAAA;IACzC,IAAI,MAAM,GAAG,CAAC,CAAC;AACf,IAAA,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IACnB,CAAC,CAAC,mBAAmB,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC;IAAC,MAAM,IAAI,CAAC,CAAC;AAC3D,IAAA,KAAK,IAAI,GAAG,IAAI,CAAC,CAAC,iBAAiB,EAAE;QACjC,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAAC,MAAM,IAAI,CAAC,CAAC;AACzD,QAAA,CAAC,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC;QAC9B,GAAG,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAAC,MAAM,IAAI,CAAC,CAAC;AACnE,KAAA;AACD,IAAA,KAAK,IAAI,EAAE,IAAI,CAAC,CAAC,WAAW,EAAE;QAC1B,EAAE,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAAC,MAAM,IAAI,CAAC,CAAC;QACxD,CAAC,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;AACrD,QAAA,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAAC,MAAM,IAAI,CAAC,CAAC;AAClE,KAAA;AACD,IAAA,MAAM,GAAG,eAAe,IAAI,CAAC,CAAC;AAC9B,IAAA,KAAK,IAAI,GAAG,IAAI,CAAC,CAAC,UAAU,EAAE;QAC1B,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAAC,MAAM,IAAI,CAAC,CAAC;QACzD,CAAC,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,GAAG,CAAC;AAC7B,QAAA,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAAC,MAAM,IAAI,CAAC,CAAC;QAChE,GAAG,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAAC,MAAM,IAAI,CAAC,CAAC;QAChE,IAAI,SAAS,GAAG,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,GAAG,QAAQ,GAAG,GAAG,CAAC,CAAC,CAAC;AAC/D,QAAA,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,GAAG,SAAS,CAAC;QAC/B,CAAC,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC,GAAG,SAAS,CAAC;QACvC,CAAC,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,GAAG,CAAC,QAAQ,CAAC;AACtC,QAAA,CAAC,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;QACtD,MAAM,IAAI,CAAC,CAAC;AACf,KAAA;IACD,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC,iBAAiB,EAAE,CAAC,EAAE,CAAC,CAAC,QAAQ,EAAE,CAAC,EAAE,qBAAqB,IAAI,CAAC,CAAC,CAAC;AACtG;;;;"}